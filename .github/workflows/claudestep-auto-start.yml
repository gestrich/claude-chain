name: ClaudeStep Auto-Start

on:
  push:
    branches:
      - main
    paths:
      - 'claude-step/*/spec.md'

jobs:
  auto-start:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Detect changed spec files
        id: detect
        run: |
          # Find spec.md files that changed in this push
          CHANGED_SPECS=$(git diff --name-only HEAD^ HEAD | grep 'claude-step/.*/spec.md' || true)

          if [ -z "$CHANGED_SPECS" ]; then
            echo "No spec.md files changed"
            echo "projects=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract project names
          PROJECTS=""
          for spec_path in $CHANGED_SPECS; do
            # Extract project name from path: claude-step/<project>/spec.md
            project=$(echo "$spec_path" | sed 's|claude-step/\([^/]*\)/spec.md|\1|')
            PROJECTS="$PROJECTS $project"
          done

          echo "projects=$PROJECTS" >> $GITHUB_OUTPUT
          echo "Detected projects with spec changes: $PROJECTS"

      - name: Check if projects are new
        id: check_new
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PROJECTS="${{ steps.detect.outputs.projects }}"
          NEW_PROJECTS=""

          for project in $PROJECTS; do
            echo "Checking if project '$project' is new..."

            # Query for ClaudeStep PRs for this project
            # Note: This requires PRs to have project in branch name or label
            PR_COUNT=$(gh pr list \
              --label claudestep \
              --state all \
              --json headRefName \
              --jq "[.[] | select(.headRefName | startswith(\"claude-step-$project-\"))] | length")

            if [ "$PR_COUNT" -eq 0 ]; then
              echo "  → New project (no PRs found)"
              NEW_PROJECTS="$NEW_PROJECTS $project"
            else
              echo "  → Existing project ($PR_COUNT PRs found), skipping auto-trigger"
            fi
          done

          echo "new_projects=$NEW_PROJECTS" >> $GITHUB_OUTPUT
          echo "New projects to auto-trigger: $NEW_PROJECTS"

      - name: Trigger ClaudeStep for new projects
        if: steps.check_new.outputs.new_projects != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          for project in ${{ steps.check_new.outputs.new_projects }}; do
            echo "Triggering ClaudeStep for project: $project"
            gh workflow run claudestep.yml \
              -f project_name="$project" \
              -f base_branch="main" \
              -f checkout_ref="main"
          done

      - name: Generate summary
        if: always()
        run: |
          echo "# ClaudeStep Auto-Start Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -z "${{ steps.detect.outputs.projects }}" ]; then
            echo "No spec.md files were changed in this push." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "## Projects with spec.md changes:" >> $GITHUB_STEP_SUMMARY
          for project in ${{ steps.detect.outputs.projects }}; do
            echo "- $project" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.check_new.outputs.new_projects }}" ]; then
            echo "## Auto-triggered for new projects:" >> $GITHUB_STEP_SUMMARY
            for project in ${{ steps.check_new.outputs.new_projects }}; do
              echo "- ✅ $project (first task will be started)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "No new projects detected. Existing projects rely on PR merge triggers." >> $GITHUB_STEP_SUMMARY
          fi
